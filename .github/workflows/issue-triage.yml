name: Issue Triage

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label and respond to new issues
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();

            let response = '';
            let labels = [];

            if (title.includes('bug') || title.includes('error') || title.includes('crash') || title.includes('broken')) {
              labels.push('bug');
              response = 'Thanks for reporting this issue!\n\n'
                + '**What happens next:**\n'
                + '1. I\'ll review this within 48 hours\n'
                + '2. If I need more info, I\'ll ask\n'
                + '3. Once confirmed, it goes into the fix queue\n\n'
                + '**While you wait:**\n'
                + '- Check if there\'s a workaround in [the docs](https://github.com/CanopyHQ/phloem)\n'
                + '- Try `phloem --version` to confirm you\'re on the latest version\n\n'
                + 'I\'ll get back to you soon!';
            }
            else if (title.includes('feature') || title.includes('request') || title.includes('suggestion') || title.includes('add')) {
              labels.push('enhancement');
              response = 'Thanks for the feature suggestion!\n\n'
                + '**What happens next:**\n'
                + '1. I\'ll review this within 48 hours\n'
                + '2. If it aligns with the roadmap, I\'ll add it to planning\n'
                + '3. Popular requests get prioritized\n\n'
                + '**Note:** Phloem is maintained by one person, so I focus on high-impact features. '
                + 'The best way to increase priority is to react to issues you care about!';
            }
            else if (title.includes('how') || title.includes('?') || title.includes('help') || title.includes('question')) {
              labels.push('question');
              response = 'Thanks for your question!\n\n'
                + '**Quick resources:**\n'
                + '- [Documentation](https://github.com/CanopyHQ/phloem)\n'
                + '- [Getting Started Guide](https://github.com/CanopyHQ/phloem#getting-started)\n'
                + '- [FAQ](https://github.com/CanopyHQ/phloem#faq)\n\n'
                + 'If the docs don\'t answer your question, I\'ll respond within 48 hours!';
            }
            else {
              labels.push('needs-triage');
              response = 'Thanks for opening this issue!\n\n'
                + 'I\'ll review it within 48 hours and respond with next steps.\n\n'
                + '**Helpful info to include (if not already):**\n'
                + '- Phloem version (`phloem --version`)\n'
                + '- OS and version\n'
                + '- Steps to reproduce (if applicable)';
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: response
            });

      - name: Notify on critical issues
        if: contains(github.event.issue.title, 'critical') || contains(github.event.issue.title, 'urgent') || contains(github.event.issue.title, 'security')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['priority-high']
            });
